name: Landscape Sync Check

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create PR for missing projects'
        required: false
        default: false
        type: boolean

env:
  GO_VERSION: '1.22'

jobs:
  check-landscape-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build landscape-sync tool
        working-directory: utilities/landscape-sync
        run: |
          go mod download
          go build -o landscape-sync .

      - name: Run landscape sync check
        id: sync-check
        working-directory: utilities/landscape-sync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./landscape-sync --verbose --output=report.md
          ./landscape-sync --json --output=results.json
          ./landscape-sync --yaml --output=suggested-entries.yaml

          # Count missing projects
          MISSING_COUNT=$(jq 'length' results.json)
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT

          # Check if any projects are missing
          if [ "$MISSING_COUNT" -gt "0" ]; then
            echo "has_missing=true" >> $GITHUB_OUTPUT
          else
            echo "has_missing=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: landscape-sync-report
          path: |
            utilities/landscape-sync/report.md
            utilities/landscape-sync/results.json
            utilities/landscape-sync/suggested-entries.yaml
          retention-days: 30

      - name: Create or update issue
        if: steps.sync-check.outputs.has_missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('utilities/landscape-sync/report.md', 'utf8');
            const missingCount = ${{ steps.sync-check.outputs.missing_count }};

            const issueTitle = 'ðŸ”„ Landscape Sync: Projects may be missing from CNCF Landscape';
            const issueBody = `## Automated Landscape Sync Check

            This is an automated report from the landscape-sync tool.

            **Found ${missingCount} project(s)** that passed GitVote but may not be in the CNCF Landscape.

            ${report}

            ---

            ### Next Steps

            1. Review the list of potentially missing projects
            2. Verify each project's onboarding status
            3. For confirmed missing projects, create a PR to the [cncf/landscape](https://github.com/cncf/landscape) repository

            ### Artifacts

            Download the full report and suggested YAML entries from the [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}).

            ---
            *This issue was automatically generated by the landscape-sync workflow.*
            `;

            // Search for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'landscape-sync',
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue
              const existingIssue = existingIssues.data[0];
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody,
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['landscape-sync', 'automated'],
              });
              console.log('Created new landscape sync issue');
            }

      - name: Close issue if no missing projects
        if: steps.sync-check.outputs.has_missing == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            // Search for existing open issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'landscape-sync',
            });

            for (const issue of existingIssues.data) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'âœ… All GitVote passed projects are now in the CNCF Landscape. Closing this issue.',
              });
              
              console.log(`Closed issue #${issue.number}`);
            }

      - name: Summary
        run: |
          echo "## Landscape Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Missing projects:** ${{ steps.sync-check.outputs.missing_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.sync-check.outputs.has_missing }}" == "true" ]; then
            echo "âš ï¸ Some projects may need to be added to the CNCF Landscape." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See the uploaded artifacts for full details." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… All GitVote passed projects are in the CNCF Landscape!" >> $GITHUB_STEP_SUMMARY
          fi
