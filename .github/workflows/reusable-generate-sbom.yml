name: Generate SBOM (Reusable)

on:
  workflow_call:
    inputs:
      matrix:
        required: true
        type: string
      job_name:
        required: true
        type: string
      sbom_path_prefix:
        required: false
        type: string
        default: ''
      force_regenerate:
        required: false
        type: string
        default: 'false'
      releases_mode:
        required: false
        type: string
        default: 'recent'
      max_releases:
        required: false
        type: string
        default: '3'

jobs:
  generate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix: ${{ fromJson(inputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false

      - name: Install bom tool and go-licenses
        run: |
          go install sigs.k8s.io/bom/cmd/bom@latest
          go install github.com/google/go-licenses@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Get stable releases and generate SBOMs
        id: generate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_REGENERATE: ${{ inputs.force_regenerate }}
          RELEASES_MODE: ${{ inputs.releases_mode }}
          MAX_RELEASES: ${{ inputs.max_releases }}
          SBOM_PATH_PREFIX: ${{ inputs.sbom_path_prefix }}
        run: |
          set -e
          
          OWNER="${{ matrix.owner }}"
          REPO="${{ matrix.repo }}"
          PROJECT_NAME="${{ matrix.name }}"
          SANITIZED_PROJECT=$(echo "$PROJECT_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd '[:alnum:]-')
          
          if [ -n "$SBOM_PATH_PREFIX" ]; then
            SBOM_BASE_DIR="supply-chain/sbom/${SBOM_PATH_PREFIX}/${OWNER}/${REPO}"
          else
            SBOM_BASE_DIR="supply-chain/sbom/${SANITIZED_PROJECT}/${REPO}"
          fi
          
          PROCESSED=0
          ONE_WEEK_AGO=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-7d +%Y-%m-%dT%H:%M:%SZ)
          
          echo "::group::Processing $OWNER/$REPO"
          echo "Releases mode: $RELEASES_MODE"
          
          extract_go_licenses() {
            local DIR="$1"
            local OUTPUT_FILE="$2"
            
            if [ ! -f "$DIR/go.mod" ]; then
              echo "[]" > "$OUTPUT_FILE"
              return 0
            fi
            
            cd "$DIR"
            go mod download 2>/dev/null || true
            
            local LICENSES_CSV
            LICENSES_CSV=$(go-licenses csv ./... 2>/dev/null || echo "")
            
            if [ -z "$LICENSES_CSV" ]; then
              echo "[]" > "$OUTPUT_FILE"
              cd - > /dev/null
              return 0
            fi
            
            echo "$LICENSES_CSV" | awk -F',' '{
              gsub(/"/, "\\\"", $1);
              id = $1; gsub(/[^a-zA-Z0-9]/, "-", id); id = substr(id, 1, 50);
              printf "{\"licenseId\": \"LicenseRef-%s\", \"extractedText\": \"License: %s\", \"name\": \"%s\", \"comment\": \"Package: %s\"}\n", id, $3, $3, $1
            }' | jq -s '.' > "$OUTPUT_FILE" 2>/dev/null || echo "[]" > "$OUTPUT_FILE"
            
            cd - > /dev/null
          }
          
          generate_sbom() {
            local TAG="$1"
            local VERSION=$(echo "$TAG" | sed 's/^v//')
            local SBOM_DIR="${SBOM_BASE_DIR}/${VERSION}"
            local SBOM_FILE="${SBOM_DIR}/${REPO}.json"
            
            if [ -f "$SBOM_FILE" ] && [ "$FORCE_REGENERATE" != "true" ]; then
              echo "SBOM already exists, skipping..."
              return 1
            fi
            
            echo "Generating SBOM for $OWNER/$REPO@$TAG..."
            
            local TEMP_DIR=$(mktemp -d)
            if ! git clone --depth 1 --branch "$TAG" "https://github.com/${OWNER}/${REPO}.git" "$TEMP_DIR" 2>/dev/null; then
              rm -rf "$TEMP_DIR"
              return 1
            fi
            
            mkdir -p "$SBOM_DIR"
            
            local SBOM_NAME="${OWNER}/${REPO} ${TAG}"
            local SBOM_NAMESPACE="https://github.com/${OWNER}/${REPO}/releases/tag/${TAG}"
            
            if bom generate --format json --name "$SBOM_NAME" --namespace "$SBOM_NAMESPACE" --output "$SBOM_FILE" "$TEMP_DIR" 2>/dev/null; then
              local LICENSES_FILE=$(mktemp)
              extract_go_licenses "$TEMP_DIR" "$LICENSES_FILE"
              
              local TEMP_SBOM=$(mktemp)
              jq --arg owner "$OWNER" \
                 --arg repo "$REPO" \
                 --arg tag "$TAG" \
                 --arg generatedAt "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                 --slurpfile licenses "$LICENSES_FILE" \
                 '
                 .creationInfo.creators += ["Tool: cncf-automation-sbom-generator"] |
                 .creationInfo.comment = "SBOM for CNCF project: \($owner)/\($repo)@\($tag)" |
                 .annotations = ((.annotations // []) + [{
                   "annotationDate": $generatedAt,
                   "annotationType": "OTHER",
                   "annotator": "Tool: cncf-automation",
                   "comment": "Repository: \($owner)/\($repo)\nVersion: \($tag)"
                 }]) |
                 .hasExtractedLicensingInfo = ((.hasExtractedLicensingInfo // []) + $licenses[0])
                 ' "$SBOM_FILE" > "$TEMP_SBOM" && mv "$TEMP_SBOM" "$SBOM_FILE"
              
              rm -f "$LICENSES_FILE"
              echo "Successfully generated SBOM: $SBOM_FILE"
              rm -rf "$TEMP_DIR"
              return 0
            else
              rm -rf "$TEMP_DIR"
              return 1
            fi
          }
          
          RELEASES=$(gh api repos/${OWNER}/${REPO}/releases --paginate -q '.[0:50]' 2>/dev/null || echo "[]")
          
          if [ "$RELEASES" == "[]" ] || [ -z "$RELEASES" ]; then
            TAGS=$(gh api repos/${OWNER}/${REPO}/tags --paginate -q '.[0:20] | .[].name' 2>/dev/null || echo "")
            
            if [ -z "$TAGS" ]; then
              echo "No tags found, skipping..."
              echo "::endgroup::"
              exit 0
            fi
            
            EFFECTIVE_MAX=$( [ "$RELEASES_MODE" == "recent" ] && echo 3 || echo $MAX_RELEASES )
            
            for TAG in $TAGS; do
              if echo "$TAG" | grep -qiE '[-\.](alpha|beta|rc|pre|dev|snapshot|nightly|canary|test|draft|wip)[0-9]*'; then
                continue
              fi
              if ! echo "$TAG" | grep -qE '^v?[0-9]+\.[0-9]+'; then
                continue
              fi
              if generate_sbom "$TAG"; then
                PROCESSED=$((PROCESSED + 1))
              fi
              if [ "$PROCESSED" -ge "$EFFECTIVE_MAX" ]; then
                break
              fi
            done
          else
            if [ "$RELEASES_MODE" == "recent" ]; then
              readarray -t RELEASE_DATA < <(echo "$RELEASES" | jq -r --arg since "$ONE_WEEK_AGO" '.[] | select(.draft == false and .prerelease == false and .published_at >= $since) | "\(.tag_name)"')
            else
              readarray -t RELEASE_DATA < <(echo "$RELEASES" | jq -r '.[] | select(.draft == false and .prerelease == false) | "\(.tag_name)"')
            fi
            
            for TAG in "${RELEASE_DATA[@]}"; do
              if echo "$TAG" | grep -qiE '[-\.](alpha|beta|rc|pre|dev|snapshot|nightly|canary|test|draft|wip)[0-9]*'; then
                continue
              fi
              if generate_sbom "$TAG"; then
                PROCESSED=$((PROCESSED + 1))
              fi
              if [ "$RELEASES_MODE" == "latest" ] && [ "$PROCESSED" -ge "$MAX_RELEASES" ]; then
                break
              fi
            done
          fi
          
          echo "::endgroup::"

      - name: Commit and push SBOMs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add supply-chain/sbom/
          
          if git diff --cached --quiet; then
            echo "No new SBOMs generated"
            exit 0
          fi
          
          git commit -m "chore(sbom): update SBOM for ${{ matrix.owner }}/${{ matrix.repo }}"
          
          for i in $(seq 1 5); do
            if git pull --rebase origin ${{ github.ref_name }} && git push origin HEAD:${{ github.ref_name }}; then
              exit 0
            fi
            sleep $((i * 5))
          done
          exit 1

