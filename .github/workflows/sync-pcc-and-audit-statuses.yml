name: Sync PCC and Audit CNCF Project Statuses

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml beautifulsoup4

      - name: Generate pcc_projects.yaml
        env:
          LFX_TOKEN: ${{ secrets.LFX_TOKEN }}
        run: |
          python scripts/fetch_pcc_projects.py
        working-directory: ./utilities/audit_project_lifecycle_across_tools
      - name: Fetch external data sources
        run: |
          mkdir -p datasources
          curl -fsSL https://raw.githubusercontent.com/cncf/landscape/master/landscape.yml -o datasources/landscape.yml
          curl -fsSL https://raw.githubusercontent.com/cncf/clomonitor/main/data/cncf.yaml -o datasources/clomonitor.yaml
          curl -fsSL https://raw.githubusercontent.com/cncf/foundation/main/project-maintainers.csv -o datasources/project-maintainers.csv
          curl -fsSL https://devstats.cncf.io/ -o datasources/devstats.html
          curl -fsSL https://raw.githubusercontent.com/cncf/artwork/main/README.md -o datasources/artwork.md
        working-directory: ./utilities/audit_project_lifecycle_across_tools
      - name: Generate status audit
        run: |
          python scripts/audit_landscape_status.py
        working-directory: ./utilities/audit_project_lifecycle_across_tools
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update pcc_projects.yaml"
          title: "chore: update pcc_projects.yaml"
          body: |
            Automated update of `pcc_projects.yaml` from LFX PCC API.

            - Source: project-service/v1/projects
            - Foundation: CNCF (a0941000002wBz4AAE)
          branch: automation/update-pcc-projects
          add-paths: |
            utilities/audit_project_lifecycle_across_tools/datasources/pcc_projects.yaml
            utilities/audit_project_lifecycle_across_tools/audit/status_audit.md
            utilities/audit_project_lifecycle_across_tools/audit/all_statuses.md
            utilities/audit_project_lifecycle_across_tools/datasources/**

